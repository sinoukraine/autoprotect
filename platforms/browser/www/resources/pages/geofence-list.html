<!--suppress JSAnnotator -->
<template>
    <div class="page " data-name="geofence-list"> <!-- page-with-subnavbar -->
        <!-- Top Navbar -->
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="link icon-only back" >
                        <i class="if-not-ios f7-icons icon-header-arrow-back"></i>
                        <i class="if-ios icon icon-back"></i>
                    </a>
                </div>
                <div class="title sliding">
                    {{@global.LANGUAGE.MENU_MSG02}}
                </div>
                <div class="right">
                    <a href="/geofence/" class="link icon-only ">
                        <i class="f7-icons icon-header-added"></i>
                    </a>

                </div>
            </div>
        </div>

        <form class="searchbar searchbar-geofences">
            <div class="searchbar-inner">
                <div class="searchbar-input-wrap">
                    <input type="search" placeholder="{{@global.LANGUAGE.COM_MSG002}}" title="{{@global.LANGUAGE.COM_MSG002}}">
                    <i class="searchbar-icon"></i>
                    <span class="input-clear-button"></span>
                </div>
                <span class="searchbar-disable-button text-color-gray">{{@global.LANGUAGE.COM_MSG001}}</span>
            </div>
        </form>

        <div class="page-content">
            <div class="searchbar-backdrop"></div>

            <div class="block searchbar-not-found">
                <div class="block-inner">{{@global.LANGUAGE.PROMPT_MSG000}}</div>
            </div>

            {{#unless DataLoaded}}
            <div key="skeleton-virtual-list" class="list media-list no-hairlines no-chevron no-margin-top">
                <ul>
                    {{#each '123'}}
                    <li>
                        <a href="#" class="item-link item-content asset skeleton-text skeleton-effect-blink" >
                            <div class="item-inner">
                                <div class="item-title-row align-items-center">
                                    <div class="item-title">
                                        Geofence Name
                                    </div>
                                    <div class="item-after">
                                        ic
                                    </div>
                                </div>
                                <div class="item-text">
                                    geofence address goes here, it can be very long, two lines.. some time it take 3 or even 4 lines
                                </div>
                            </div>
                        </a>
                    </li>
                    {{/each}}
                </ul>
            </div>
            {{else}}
            <div key="hide-on-search-block" class="block searchbar-hide-on-search text-align-center">{{@global.LANGUAGE.PROMPT_MSG043}}</div>
            {{/unless}}

            <div class="list media-list virtual-list no-chevron no-margin-top searchbar-found geofenceList" >
                <!-- keep it empty -->
            </div>

        </div>

    </div>
</template>


<script>
    // script must return component object
    return {
        data: function () {
            let self = this;

            let ret = {

            };

            return ret;
        },
        methods: {
            initList: function (geofenceListObj) {
                let self = this;


                let geofenceList = [];
                if (!self.$app.methods.isObjEmpty(geofenceListObj)){
                    let keys = Object.keys(geofenceListObj);
                    for (const key of keys) {
                        geofenceList.push(geofenceListObj[key]);
                    }
                    geofenceList.sort(function(a, b) {
                        if (a.Name < b.Name) return -1;
                        if (a.Name > b.Name) return 1;
                        return 0;
                    });
                }


                let listEl = self.$el.find('.geofenceList');

                self.VirtualList = self.$app.virtualList.create({
                    el: listEl,
                    items : geofenceList,
                    //cache: false,
                    searchAll: function (query, items) {
                        var found = [];
                        for (var i = 0; i < items.length; i++) {
                            if (items[i].Name.toLowerCase().indexOf(query.toLowerCase()) >= 0 || query.trim() === '') found.push(i);
                        }
                        return found; //return array with mathced indexes
                    },
                    height: function (item){
                        let ret = 73;
                        if(item && item.Address && item.Address.length > 55){
                            if (item.Address.length > 55){
                                ret = 93;
                            }else if(item.Address.length > 95){
                                ret = 113;
                            }
                        }
                        return ret
                    },
                    renderItem: function (item, index) {
                        let ret = `
                        <li data-index="${index}" data-code="${item.Code}" data-state="${item.State}">
                            <a href="#" class="link ripple-color-red item-menu-button bigger-touch-area geofenceMenu">
                                <i class="f7-icons icon-header-menu2 size-18"></i>
                            </a>
                            <a href="/geofence/?code=${item.Code}" class="item-link item-content">
                                <div class="item-inner">
                                    <div class="item-title-row">
                                        <div class="item-title text-transform-uppercase">${item.Name}</div>
                                        <div class="item-after"><i class="f7-icons icon-header-menu2 fake-icon"></i></div>
                                    </div>
                                    <div class="item-text">${item.Address}</div>
                                </div>
                            </a>
                        </li>`;
                        return ret;
                    },
                    emptyTemplate: `<li class="item-content">${LANGUAGE.COM_MSG040}</li>`
                });

                self.$setState({
                    DataLoaded: true
                });
                self.initSearchForm();
            },
            initSearchForm: function () {
                let self = this;
                self.$app.utils.nextFrame(()=>{
                    self.Searchbar = self.$app.searchbar.create({
                        el: self.$el.find('.searchbar-geofences'),
                        searchContainer: self.$el.find('.geofenceList'),
                        searchIn: '.item-title',
                    });
                })
            }
        },

        on: {
            pageInit: function (e, page) {
                let self = this;

                self.$app.methods.getGeofenceList(self.initList);

                page.$el.find('.geofenceList').on('click', '.geofenceMenu', function () {
                    var parentLi = $$(this).closest('li');
                    var geofenceCode = parentLi.data('code');
                    var listIndex = parentLi.data('index');

                    var state = false;
                    if (parentLi.data('state') === '1') {
                        state = true;
                    }

                    self.$app.actions.create({
                        buttons: [
                            {
                                text: `<div class="action_button_wrapper">
                                    <div class="action_button_block action_button_media text-color-lightgray">
                                        <i class="f7-icons icon-geofence-edit size-18"></i>
                                    </div>
                                    <div class="action_button_block action_button_text">
                                        ${ LANGUAGE.ASSET_EDIT_MSG00 }
                                    </div>
                                </div>`,
                                onClick: function() {
                                    //editGeofence(geofenceCode);
                                }
                            },
                            {
                                text: `<div class="action_button_wrapper">
                                    <div class="action_button_block action_button_media ${ state ? 'text-color-green' : 'text-color-lightgray' }">
                                        <i class="f7-icons icon-geofence-active size-18"></i>
                                    </div>
                                    <div class="action_button_block action_button_text">
                                        ${ LANGUAGE.COM_MSG059}
                                    </div>
                                    <label class="toggle color-green">
                                        <input type="checkbox" name="checkbox-active" ${ state ? 'checked="checked"' : '' }>
                                        <span class="toggle-icon"></span>
                                    </label>
                                </div>`,
                                onClick: function() {
                                    /*var stateNew = 1;
                                    if (parentLi.data('state') == 1) {
                                        stateNew = 0;
                                    }
                                    changeGeofenceState(arrGeofenceList[parentLi.data('index')], stateNew);*/
                                }
                            },
                            {
                                text: `<div class="action_button_wrapper">
                                    <div class="action_button_block action_button_media text-color-red">
                                        <i class="f7-icons icon-geofence-remove size-18"></i>
                                    </div>
                                    <div class="action_button_block action_button_text">
                                        ${ LANGUAGE.COM_MSG064 }
                                    </div>
                                </div>`,
                                color: 'red',
                                onClick: function() {
                                    /*App.confirm(LANGUAGE.PROMPT_MSG011, function() {
                                        deleteGeofence(geofenceCode, listIndex);
                                    });*/
                                }
                            },
                        ]
                    }).open();
                })
            },
            pageBeforeRemove: function () {
                if (this.Searchbar){
                    this.Searchbar.destroy();
                }
                if (this.VirtualList){
                    this.VirtualList.destroy();
                }
            }

        }
    };
</script>